<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Inkball</a> &gt; <a href="index.source.html" class="el_package">inkball</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package inkball;

import processing.core.PApplet;
import processing.core.PImage;
import processing.data.JSONArray;
import processing.data.JSONObject;
import processing.event.KeyEvent;
import processing.event.MouseEvent;

import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;

import java.util.*;
import java.io.*;

/**
 * Base class for the Inkball game.
 */
public class App extends PApplet {
    public static final int CELLSIZE = 32; //8;
    public static final int CELLHEIGHT = 32;

    public static final int CELLAVG = 32;
    public static final int TOPBAR = 64;
<span class="fc" id="L26">    public static int WIDTH = 576; //CELLSIZE*BOARD_WIDTH;</span>
<span class="fc" id="L27">    public static int HEIGHT = 640; //BOARD_HEIGHT*CELLSIZE+TOPBAR;</span>
<span class="fc" id="L28">    public static final int BOARD_WIDTH = WIDTH/CELLSIZE;</span>
<span class="fc" id="L29">    public static final int BOARD_HEIGHT = (HEIGHT-TOPBAR)/CELLSIZE;</span>

    public static final int FPS = 30;

    public String configPath;

<span class="fc" id="L35">    public static Random random = new Random();</span>

<span class="fc" id="L37">    public static final int[] winTile = {</span>
        0, 32, 64, 96, 128, 160, 192, 224, 256, 288, 320, 352, 384, 416, 448, 480, 512, 544, 
        544, 544, 544, 544, 544, 544, 544, 544, 544, 544, 544, 544, 544, 544, 544, 544, 544,
        512, 480, 448, 416, 384, 352, 320, 288, 256, 224, 192, 160, 128, 96, 64, 32, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };

    // Feel free to add any additional methods or attributes you want. Please put classes in different files.

<span class="fc" id="L46">    public App() {</span>
<span class="fc" id="L47">        this.configPath = &quot;config.json&quot;;</span>
<span class="fc" id="L48">    }</span>

    /**
     * Initialise the setting of the window size.
     */
	@Override
    public void settings() {
<span class="fc" id="L55">        size(WIDTH, HEIGHT);</span>
<span class="fc" id="L56">    }</span>

    private int score;
    private int winState;

    private boolean resetFlag;
    private boolean pauseFlag;
    private boolean gameEnd;
    
<span class="fc" id="L65">    private HashMap&lt;String, PImage&gt; sprites = new HashMap&lt;&gt;();</span>

    public static Level currentLevel;
    public ArrayList&lt;Level&gt; levels;
    public int current;

    public Line currentLine;

    /**
     * Method for loading images.
     */
    public PImage getSprite(String s) {
<span class="fc" id="L77">        PImage result = sprites.get(s);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (result == null) {</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (s.startsWith(&quot;brick&quot;)) {</span>
<span class="fc" id="L80">                result = loadImage(this.getClass().getResource(&quot;inkball_spritesheet.png&quot;).getPath().replace(&quot;%20&quot;, &quot; &quot;));</span>
<span class="fc" id="L81">                result = result.get(99, 166 + 33*(s.charAt(5)-'0'), CELLSIZE, CELLSIZE);</span>
            }
            else
<span class="fc" id="L84">                result = loadImage(this.getClass().getResource(s+&quot;.png&quot;).getPath().replace(&quot;%20&quot;, &quot; &quot;));</span>
<span class="fc" id="L85">            sprites.put(s, result);</span>
        }
<span class="fc" id="L87">        return result;</span>
    }

    /**
     * Returns cumulative game score.
     */
    public int getScore() {
<span class="fc" id="L94">        return score;</span>
    }

    /**
     * Load all resources such as images. Initialise the elements such as the player and map elements.
     */
	@Override
    public void setup() {
<span class="fc" id="L102">        frameRate(FPS);</span>
<span class="fc" id="L103">        strokeWeight(10);</span>
<span class="fc" id="L104">        textSize(20);</span>

		// JSON configuration:
<span class="fc" id="L107">		JSONObject config = loadJSONObject(configPath);</span>
        
		// the image is loaded from relative path: &quot;src/main/resources/inkball/...&quot;
		/*try {
            result = loadImage(URLDecoder.decode(this.getClass().getResource(filename+&quot;.png&quot;).getPath(), StandardCharsets.UTF_8.name()));
        } catch (UnsupportedEncodingException e) {
            throw new RuntimeException(e);
        }*/
<span class="fc" id="L115">        getSprite(&quot;tile&quot;);</span>
<span class="fc" id="L116">        getSprite(&quot;entrypoint&quot;);</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        for (int i = 0; i &lt; 5; i++) {</span>
<span class="fc" id="L118">            getSprite(&quot;wall&quot;+String.valueOf(i));</span>
<span class="fc" id="L119">            getSprite(&quot;ball&quot;+String.valueOf(i));</span>
<span class="fc" id="L120">            getSprite(&quot;hole&quot;+String.valueOf(i));</span>
<span class="fc" id="L121">            getSprite(&quot;brick&quot;+String.valueOf(i));</span>
        }
        
<span class="fc" id="L124">        current = 0;</span>
<span class="fc" id="L125">        levels = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L126">        JSONArray configLevels = config.getJSONArray(&quot;levels&quot;);</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">        for (int i = 0; i &lt; configLevels.size(); i++) {</span>
<span class="fc" id="L128">            Level level = new Level(this, config, configLevels.getJSONObject(i));</span>
<span class="fc" id="L129">            levels.add(level);</span>
        }
<span class="fc" id="L131">        currentLevel = levels.get(current);</span>
<span class="fc" id="L132">    }</span>

    /**
     * Receive key pressed signal from the keyboard.
     */
	@Override
    public void keyPressed(KeyEvent event) {
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (event.getKey() == 'r') {</span>
<span class="fc" id="L140">            resetFlag = true;</span>
        }
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        else if (event.getKey() == ' ') {</span>
<span class="fc" id="L143">            pauseFlag = true;</span>
        }
<span class="fc" id="L145">    }</span>

    /**
     * Receive key released signal from the keyboard.
     */
	@Override
    public void keyReleased() {
<span class="pc bpc" id="L152" title="1 of 4 branches missed.">        if (resetFlag &amp;&amp; gameEnd) {</span>
<span class="nc" id="L153">            resetFlag = false;</span>
<span class="nc" id="L154">            gameEnd = false;</span>
<span class="nc" id="L155">            score = 0;</span>
<span class="nc" id="L156">            setup();</span>
        }
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (resetFlag) {</span>
<span class="fc" id="L159">            JSONObject config = loadJSONObject(configPath);</span>
<span class="fc" id="L160">            JSONArray configLevels = config.getJSONArray(&quot;levels&quot;);</span>
<span class="fc" id="L161">            currentLevel = new Level(this, config, configLevels.getJSONObject(current));</span>
<span class="fc" id="L162">            levels.set(current, currentLevel);</span>
<span class="fc" id="L163">            resetFlag = false;</span>
        }
<span class="fc bfc" id="L165" title="All 2 branches covered.">        if (pauseFlag) {</span>
<span class="pc bpc" id="L166" title="2 of 4 branches missed.">            if (!currentLevel.isLost() &amp;&amp; !gameEnd)</span>
<span class="fc" id="L167">                currentLevel.pause();</span>
<span class="fc" id="L168">            pauseFlag = false;</span>
        }
<span class="fc" id="L170">    }</span>

    @Override
    public void mousePressed(MouseEvent e) {
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if (currentLevel.isLost()) return;</span>

<span class="pc bpc" id="L176" title="1 of 4 branches missed.">        if (e.getButton() == RIGHT || e.isControlDown()) {</span>
<span class="fc" id="L177">            deleteLine(e);</span>
        }
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        else if (e.getButton() == LEFT) { // create a new player-drawn line object</span>
<span class="fc" id="L180">            currentLevel.drawnLines.add(new Line(e.getX(), e.getY()));</span>
<span class="fc" id="L181">            currentLine = currentLevel.drawnLines.getLast();</span>
        }
<span class="fc" id="L183">    }</span>
	
	@Override
    public void mouseDragged(MouseEvent e) {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (currentLevel.isLost()) return;</span>

        // add line segments to player-drawn line object if left mouse button is held
<span class="pc bpc" id="L190" title="1 of 4 branches missed.">        if (e.getButton() == LEFT &amp;&amp; !e.isControlDown()) {</span>
<span class="fc" id="L191">            currentLine.addSegment(e.getX(), e.getY());</span>
        }
		
		// remove player-drawn line object if right mouse button is held 
		// and mouse position collides with the line
<span class="pc bpc" id="L196" title="1 of 4 branches missed.">        if (e.getButton() == RIGHT || e.isControlDown()) {</span>
<span class="fc" id="L197">            deleteLine(e);</span>
        }
<span class="fc" id="L199">    }</span>

    @Override
<span class="nc" id="L202">    public void mouseReleased(MouseEvent e) {}</span>

    /**
     * Method for deleting the line that overlaps with the mouse cursor.
     */
    public void deleteLine(MouseEvent e) {
<span class="fc" id="L208">        Line collidedLine = null;</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">        for (Line line : currentLevel.drawnLines) {</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">            if (line.collidesWith(e.getX(), e.getY(), 5) != null) {</span>
<span class="fc" id="L211">                collidedLine = line;</span>
            }
<span class="fc" id="L213">        }</span>
<span class="fc" id="L214">        currentLevel.drawnLines.remove(collidedLine);</span>
<span class="fc" id="L215">    }</span>

    /**
     * Draw all elements in the game by current frame.
     */
	@Override
    public void draw() {

        //----------------------------------
        //display Board for current level:
        //----------------------------------
<span class="fc" id="L226">        currentLevel = levels.get(current);</span>

<span class="fc bfc" id="L228" title="All 2 branches covered.">        for (int i = currentLevel.grid.length - 1; i &gt;= 0; i--) {</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">            for (int j = currentLevel.grid[i].length - 1; j &gt;= 0; j--) {</span>
<span class="fc" id="L230">                currentLevel.grid[i][j].draw(this);</span>
            }
        }

<span class="fc bfc" id="L234" title="All 2 branches covered.">        for (Ball ball : currentLevel.balls) {</span>
<span class="fc" id="L235">            ball.draw(this);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">            if (currentLevel.isPaused() == false)</span>
<span class="fc" id="L237">                ball.move(currentLevel);</span>
<span class="fc" id="L238">        }</span>

<span class="fc" id="L240">        LinkedList&lt;Line&gt; removedLines = new LinkedList&lt;&gt;();</span>
        Segment collidedSegment;

<span class="fc bfc" id="L243" title="All 2 branches covered.">        for (Line drawnLine : currentLevel.drawnLines) {</span>
<span class="fc" id="L244">            drawnLine.draw(this);</span>

<span class="pc bpc" id="L246" title="1 of 2 branches missed.">            for (Ball ball : currentLevel.balls) {</span>
<span class="nc" id="L247">                collidedSegment = drawnLine.collidesWith(ball.getX(), ball.getY(), ball.getRadius());</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (collidedSegment != null) {</span>
<span class="nc" id="L250">                    ball.reflectOff(collidedSegment);</span>
<span class="nc" id="L251">                    removedLines.add(drawnLine);</span>
                }
<span class="nc" id="L253">            }</span>
<span class="fc" id="L254">        }</span>

<span class="fc" id="L256">        currentLevel.drawnLines.removeAll(removedLines);</span>

<span class="fc" id="L258">        LinkedList&lt;Ball&gt; removedBalls = new LinkedList&lt;&gt;();</span>

<span class="fc bfc" id="L260" title="All 2 branches covered.">        for (Hole hole : currentLevel.holes) {</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">            for (Ball ball : currentLevel.balls) {</span>
<span class="fc" id="L262">                hole.attract(ball);</span>

<span class="pc bpc" id="L264" title="1 of 2 branches missed.">                if (hole.captures(ball)) {</span>
<span class="nc" id="L265">                    removedBalls.add(ball);</span>
<span class="nc" id="L266">                    currentLevel.updateScore(ball, hole);</span>
                }
<span class="fc" id="L268">            }</span>
<span class="fc" id="L269">        }</span>

<span class="fc" id="L271">        currentLevel.balls.removeAll(removedBalls);</span>

        // refresh topbar
<span class="fc" id="L274">        fill(200);</span>
<span class="fc" id="L275">        strokeWeight(0);</span>
<span class="fc" id="L276">        rect(0, 0, WIDTH, TOPBAR);</span>
<span class="fc" id="L277">        strokeWeight(10);</span>
<span class="fc" id="L278">        fill(0);</span>

<span class="fc bfc" id="L280" title="All 2 branches covered.">        if (currentLevel.isLost()) {</span>
<span class="fc" id="L281">            textSize(16);</span>
<span class="fc" id="L282">            text(&quot;=== TIME'S UP ===&quot;, 240, App.TOPBAR-22);</span>
<span class="fc" id="L283">            textSize(20);</span>
        }
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        else if (currentLevel.isPaused())</span>
<span class="nc" id="L286">            text(&quot;*** PAUSED ***&quot;, 240, App.TOPBAR-22);</span>

<span class="fc" id="L288">        currentLevel.displayTimer(this);</span>

        //----------------------------------
        //display score
        //----------------------------------
<span class="fc" id="L293">        currentLevel.displayScore(this);</span>

<span class="fc" id="L295">        fill(0);</span>
<span class="fc" id="L296">        rect(16, 16, 160, 32);</span>

<span class="fc" id="L298">        LinkedList&lt;Ball&gt; topbarBalls = currentLevel.topbarBalls;</span>

<span class="fc" id="L300">        clip(16, 16, 160, 32); // do not draw outside of the black box</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">        for (Ball queuedBall : topbarBalls) {</span>
<span class="fc" id="L302">            queuedBall.draw(this);</span>
<span class="pc bpc" id="L303" title="1 of 4 branches missed.">            if (currentLevel.topbarBallsShifting() &amp;&amp; currentLevel.isPaused() == false)</span>
<span class="fc" id="L304">                queuedBall.shift();</span>
<span class="fc" id="L305">        }</span>
<span class="fc" id="L306">        noClip();</span>

<span class="fc bfc" id="L308" title="All 2 branches covered.">        if (!topbarBalls.isEmpty()) {</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">            if (topbarBalls.getFirst().getX() == App.CELLSIZE)</span>
<span class="fc" id="L310">                currentLevel.stopShifting();</span>
<span class="fc" id="L311">            currentLevel.displaySpawnTimer(this);</span>
<span class="fc" id="L312">        } else currentLevel.stopShifting();</span>
        
		//----------------------------------
		//display game end message
        //----------------------------------
<span class="fc bfc" id="L317" title="All 2 branches covered.">        if (currentLevel.hasEnded()) {</span>
<span class="fc" id="L318">            score = currentLevel.getScore();</span>
<span class="fc" id="L319">            winState = 0;</span>

<span class="pc bpc" id="L321" title="1 of 2 branches missed.">            if (current == levels.size() - 1) {</span>
<span class="nc" id="L322">                text(&quot;=== ENDED ===&quot;, 240, App.TOPBAR-22);</span>
<span class="nc" id="L323">                gameEnd = true;</span>
            }
            else {
<span class="fc" id="L326">                current++;</span>
<span class="fc" id="L327">                levels.get(current).setScore(score);</span>
            }
        }

<span class="fc bfc" id="L331" title="All 2 branches covered.">        else if (currentLevel.remainingBalls() == 0) {</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">            if (frameCount % 2 == 0)</span>
<span class="nc" id="L333">                currentLevel.countRemainingTime(this);</span>
<span class="fc" id="L334">            image(getSprite(&quot;wall4&quot;), winTile[winState % 68], winTile[(winState+51) % 68]+App.TOPBAR);</span>
<span class="fc" id="L335">            image(getSprite(&quot;wall4&quot;), winTile[(winState+34) % 68], winTile[(winState+17) % 68]+App.TOPBAR);</span>
<span class="fc" id="L336">            winState += (frameCount % 2);</span>
        }

<span class="fc" id="L339">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L342">        PApplet.main(&quot;inkball.App&quot;);</span>
<span class="nc" id="L343">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>